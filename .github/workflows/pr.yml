name: Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: Get PR info
      id: pr-info
      run: |
        echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
        echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT

    - name: Count changed files
      id: changes
      run: |
        FILES_CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | wc -l)
        PYTHON_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep '\.py$' | wc -l || echo "0")
        TEST_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep 'test_.*\.py$' | wc -l || echo "0")
        echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
        echo "python_files=$PYTHON_FILES" >> $GITHUB_OUTPUT
        echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT

    - name: PR Summary Comment
      uses: actions/github-script@v7
      with:
        script: |
          const output = `#### Pull Request Summary ðŸ“Š

          **Changes:**
          - Total files changed: ${{ steps.changes.outputs.files_changed }}
          - Python files changed: ${{ steps.changes.outputs.python_files }}
          - Test files changed: ${{ steps.changes.outputs.test_files }}

          **Author:** @${{ steps.pr-info.outputs.pr_author }}

          ---
          *Automated checks are running. Results will be posted when complete.*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  test-changes:
    name: Test Changed Code
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Get changed Python files
      id: changed-files
      run: |
        CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep '\.py$' | tr '\n' ' ' || echo "")
        echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "Changed Python files: $CHANGED_FILES"

    - name: Run tests
      run: |
        pytest -v --tb=short --cov=roon_pytui --cov-report=term --cov-report=xml

    - name: Comment test results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let message = '#### Test Results ðŸ§ª\n\n';

          try {
            const coverage = fs.readFileSync('coverage.xml', 'utf8');
            const match = coverage.match(/line-rate="([0-9.]+)"/);
            if (match) {
              const coveragePct = (parseFloat(match[1]) * 100).toFixed(2);
              message += `**Coverage:** ${coveragePct}%\n\n`;

              if (coveragePct >= 80) {
                message += 'âœ… Coverage meets threshold (80%)\n';
              } else {
                message += 'âš ï¸ Coverage below threshold (80%)\n';
              }
            }
          } catch (error) {
            message += 'âš ï¸ Could not read coverage report\n';
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });

  lint-changes:
    name: Lint Changed Files
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install ruff
      run: |
        python -m pip install --upgrade pip
        pip install ruff

    - name: Get changed Python files
      id: changed-files
      run: |
        CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep '\.py$' | tr '\n' ' ' || echo "")
        echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT

    - name: Lint changed files
      if: steps.changed-files.outputs.files != ''
      run: |
        ruff check ${{ steps.changed-files.outputs.files }} --output-format=github
        ruff format --check ${{ steps.changed-files.outputs.files }}

  size-label:
    name: PR Size Labeling
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Calculate PR size
      id: size
      run: |
        ADDITIONS=$(git diff --shortstat origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -oP '\d+(?= insertion)' || echo "0")
        DELETIONS=$(git diff --shortstat origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -oP '\d+(?= deletion)' || echo "0")
        TOTAL=$((ADDITIONS + DELETIONS))
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "Total changes: $TOTAL lines"

    - name: Add size label
      uses: actions/github-script@v7
      with:
        script: |
          const total = parseInt('${{ steps.size.outputs.total }}');
          let label = '';

          if (total < 10) {
            label = 'size/XS';
          } else if (total < 100) {
            label = 'size/S';
          } else if (total < 500) {
            label = 'size/M';
          } else if (total < 1000) {
            label = 'size/L';
          } else {
            label = 'size/XL';
          }

          // Remove old size labels
          const labels = await github.rest.issues.listLabelsOnIssue({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          for (const existingLabel of labels.data) {
            if (existingLabel.name.startsWith('size/')) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: existingLabel.name,
              });
            }
          }

          // Add new size label
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: [label]
          });
